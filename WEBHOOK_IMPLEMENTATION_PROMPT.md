# Webhook Implementation Prompt for Medusa MCP & Stripe Docs

## Situation Overview

I have a MedusaJS v2 application with Stripe payment integration, but I'm missing the backend webhook endpoint handler. Here's my current setup:

### Current Configuration

**Backend (MedusaJS):**
- MedusaJS v2 with `@medusajs/medusa/payment-stripe` module provider
- Configured in `medusa-config.ts`:
  ```typescript
  {
    resolve: '@medusajs/medusa/payment-stripe',
    id: 'stripe',
    options: {
      apiKey: process.env.STRIPE_API_KEY,
      webhookSecret: process.env.STRIPE_WEBHOOK_SECRET,
      automaticPaymentMethods: true,
    },
  }
  ```
- **Missing:** `/hooks/payment/[provider_id]` route handler in `src/api/hooks/payment/[provider_id]/route.ts`
- Directory exists but is empty: `busbasisberlin/src/api/hooks/payment/[provider_id]/`

**Frontend (Next.js):**
- Has redirect callback handler: `/api/capture-payment/[cartId]/route.ts`
- Uses Stripe PaymentElement and ExpressCheckoutElement
- Handles redirect-based payments (PayPal, iDEAL, etc.)

### Questions for Medusa MCP

1. **Does Medusa automatically create the `/hooks/payment/[provider_id]` endpoint?**
   - The docs say "The Medusa application has a `/hooks/payment/[provider_id]` API route out-of-the-box"
   - But I don't see it in my codebase. Is this route automatically generated by the Payment Module?

2. **If the route is NOT automatic, what is the exact implementation I need?**
   - What should the route handler look like?
   - How does it integrate with the Payment Module's `getWebhookActionAndData` method?
   - What's the proper way to forward Stripe webhook events to the payment module?

3. **What's the relationship between:**
   - The webhook endpoint (`/hooks/payment/stripe`)
   - The frontend redirect callback (`/api/capture-payment/[cartId]`)
   - The Payment Module's webhook processing

4. **For my setup:**
   - Provider ID: `stripe` (from medusa-config.ts)
   - Expected webhook URL: `https://my-backend-url/hooks/payment/stripe`
   - Is this correct, or should it be `/hooks/payment/pp_stripe_stripe`?

### Questions for Stripe Docs AI

1. **Webhook Event Flow:**
   - When using Stripe PaymentElement with `confirmPayment()` and `redirect: 'if_required'`
   - What webhook events should I listen for?
   - What's the difference between handling redirects vs webhooks?

2. **Payment Intent Lifecycle:**
   - For cards (no redirect): Does Stripe send webhooks even if payment succeeds immediately?
   - For redirect methods (PayPal, iDEAL): Should I rely on redirect callback or webhook?
   - What happens if redirect succeeds but webhook fails (or vice versa)?

3. **Best Practices:**
   - Should I handle both redirect callback AND webhook, or is one primary?
   - How to handle race conditions between redirect and webhook?
   - What's the recommended pattern for ensuring order completion?

### Current Payment Flow

```
1. User clicks "Place order"
   ↓
2. Frontend calls stripe.confirmPayment() with redirect: 'if_required'
   ↓
3a. If redirect required (PayPal, iDEAL):
    → Stripe redirects → /api/capture-payment/[cartId]
    → Frontend validates and calls placeOrder()

3b. If no redirect (Card, Apple Pay):
    → Payment succeeds immediately
    → ??? Webhook should confirm → Backend updates order ???
```

### What I Need

1. **Clarification:** Is the webhook endpoint automatic or manual?
2. **Implementation:** If manual, provide the exact route handler code
3. **Configuration:** Correct webhook URL format for Stripe Dashboard
4. **Best Practice:** Recommended approach for handling both redirects and webhooks

### Environment

- MedusaJS: v2 (using `@medusajs/framework`)
- Stripe: Latest PaymentElement API
- Payment Methods: Cards, Apple Pay, Google Pay, PayPal, iDEAL, Klarna
- Deployment: Production (needs webhook verification)

---

## Expected Response Format

Please provide:
1. **Medusa MCP:** Whether route is automatic or needs manual implementation
2. **If manual:** Complete route handler code example
3. **Stripe Docs:** Webhook event recommendations and best practices
4. **Integration:** How redirect callback and webhook work together

