name: Deploy to VPS with Domain
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
      SSL_CERT_NAME: ${{ secrets.SSL_CERT_NAME }}
      SSL_KEY_NAME: ${{ secrets.SSL_KEY_NAME }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
      S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_FILE_URL: ${{ secrets.S3_FILE_URL }}
      COMPANY_NAME: ${{ secrets.COMPANY_NAME }}
      COMPANY_ADDRESS: ${{ secrets.COMPANY_ADDRESS }}
      COMPANY_POSTAL_CODE: ${{ secrets.COMPANY_POSTAL_CODE }}
      COMPANY_CITY: ${{ secrets.COMPANY_CITY }}
      COMPANY_EMAIL: ${{ secrets.COMPANY_EMAIL }}
      COMPANY_PHONE: ${{ secrets.COMPANY_PHONE }}
      COMPANY_TAX_ID: ${{ secrets.COMPANY_TAX_ID }}
      COMPANY_BANK_INFO: ${{ secrets.COMPANY_BANK_INFO }}
      PDF_FOOTER_TEXT: ${{ secrets.PDF_FOOTER_TEXT }}
      EMAIL_SIGNATURE: ${{ secrets.EMAIL_SIGNATURE }}
      EMAIL_FOOTER: ${{ secrets.EMAIL_FOOTER }}
      MEDUSA_BACKEND_URL: ${{ secrets.MEDUSA_BACKEND_URL }}
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: DOMAIN_NAME,SSL_CERT_NAME,SSL_KEY_NAME,POSTGRES_PASSWORD,JWT_SECRET,COOKIE_SECRET,RESEND_API_KEY,RESEND_FROM_EMAIL,S3_ACCESS_KEY_ID,S3_SECRET_ACCESS_KEY,S3_REGION,S3_BUCKET,S3_ENDPOINT,S3_FILE_URL,COMPANY_NAME,COMPANY_ADDRESS,COMPANY_POSTAL_CODE,COMPANY_CITY,COMPANY_EMAIL,COMPANY_PHONE,COMPANY_TAX_ID,COMPANY_BANK_INFO,PDF_FOOTER_TEXT,EMAIL_SIGNATURE,EMAIL_FOOTER,MEDUSA_BACKEND_URL
          script: |
            cd /opt/medusa-app/busbasisberlin

            # Pull latest code with proper authentication
            git pull origin main

            # Make sure script is executable
            chmod +x ./scripts/deploy-with-domain.sh

            # Run deployment
            ./scripts/deploy-with-domain.sh
